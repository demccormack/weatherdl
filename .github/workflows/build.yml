name: Build

on:
  workflow_call:
  workflow_dispatch:

jobs:
  build-releases:
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: windows
          - os: macos-13
            platform: macos-intel
          - os: macos-latest
            platform: macos-arm64
          - os: ubuntu-latest
            platform: ubuntu
    runs-on: ${{ matrix.os }}
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.12

      - name: Set up build environment (Windows)
        if: matrix.platform == 'windows'
        run: |
          python -m venv venv
          .\venv\Scripts\Activate.ps1
          python -m pip install --upgrade pip
          python -m pip install -r requirements-prod.txt -r requirements-build.txt

      - name: Build for Windows
        if: matrix.platform == 'windows'
        run: |
          .\venv\Scripts\Activate.ps1
          python -m PyInstaller -n weatherdl --onefile --add-data 'venv\Lib\site-packages\pptx\templates:pptx\templates' src\main.py

      - name: Copy config files (Windows)
        if: matrix.platform == 'windows'
        run: |
          Copy-Item config.json dist

      - name: Set up build environment (macOS/Ubuntu)
        if: matrix.platform != 'windows'
        run: |
          python3 -m venv venv
          source venv/bin/activate
          python3 -m pip install -r requirements-prod.txt -r requirements-build.txt

      - name: Build for macOS/Ubuntu
        if: matrix.platform != 'windows'
        run: |
          source venv/bin/activate
          python3 -m PyInstaller -n weatherdl --onefile --add-data "venv/lib/*/site-packages/pptx/templates:pptx/templates" src/main.py

      - name: Copy config files (macOS/Ubuntu)
        if: matrix.platform != 'windows'
        run: |
          cp config.json dist

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: weatherdl-for-${{ matrix.platform }}
          path: dist
